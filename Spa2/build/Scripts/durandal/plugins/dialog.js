define(["durandal/system","durandal/app","durandal/composition","durandal/activator","durandal/viewEngine","jquery","knockout"],function(e,t,i,n,r,o,a){function u(t){return e.defer(function(i){e.isString(t)?e.acquire(t).then(function(t){i.resolve(e.resolveObject(t))}).fail(function(i){e.error("Failed to load dialog module ("+t+"). Details: "+i.message)}):i.resolve(t)}).promise()}var s,c={},l=0,d=function(e,t,i){this.message=e,this.title=t||d.defaultTitle,this.options=i||d.defaultOptions};return d.prototype.selectOption=function(e){s.close(this,e)},d.prototype.getView=function(){return r.processMarkup(d.defaultViewMarkup)},d.setViewUrl=function(e){delete d.prototype.getView,d.prototype.viewUrl=e},d.defaultTitle=t.title||"Application",d.defaultOptions=["Ok"],d.defaultViewMarkup=['<div data-view="plugins/messageBox" class="messageBox">','<div class="modal-header">','<h3 data-bind="text: title"></h3>',"</div>",'<div class="modal-body">','<p class="message" data-bind="text: message"></p>',"</div>",'<div class="modal-footer" data-bind="foreach: options">','<button class="btn" data-bind="click: function () { $parent.selectOption($data); }, text: $data, css: { \'btn-primary\': $index() == 0, autofocus: $index() == 0 }"></button>',"</div>","</div>"].join("\n"),s={MessageBox:d,currentZIndex:1050,getNextZIndex:function(){return++this.currentZIndex},isOpen:function(){return l>0},getContext:function(e){return c[e||"default"]},addContext:function(e,t){t.name=e,c[e]=t;var i="show"+e.substr(0,1).toUpperCase()+e.substr(1);this[i]=function(t,i){return this.show(t,i,e)}},createCompositionSettings:function(e,t){var i={model:e,activate:!1};return t.attached&&(i.attached=t.attached),t.compositionComplete&&(i.compositionComplete=t.compositionComplete),i},getDialog:function(e){return e?e.__dialog__:void 0},close:function(e){var t=this.getDialog(e);if(t){var i=Array.prototype.slice.call(arguments,1);t.close.apply(t,i)}},show:function(t,r,o){var a=this,s=c[o||"default"];return e.defer(function(e){u(t).then(function(t){var o=n.create();o.activateItem(t,r).then(function(n){if(n){var r=t.__dialog__={owner:t,context:s,activator:o,close:function(){var i=arguments;o.deactivateItem(t,!0).then(function(n){n&&(l--,s.removeHost(r),delete t.__dialog__,0==i.length?e.resolve():1==i.length?e.resolve(i[0]):e.resolve.apply(e,i))})}};r.settings=a.createCompositionSettings(t,s),s.addHost(r),l++,i.compose(r.host,r.settings)}else e.resolve(!1)})})}).promise()},showMessage:function(t,i,n){return e.isString(this.MessageBox)?s.show(this.MessageBox,[t,i||d.defaultTitle,n||d.defaultOptions]):s.show(new this.MessageBox(t,i,n))},install:function(e){t.showDialog=function(e,t,i){return s.show(e,t,i)},t.showMessage=function(e,t,i){return s.showMessage(e,t,i)},e.messageBox&&(s.MessageBox=e.messageBox),e.messageBoxView&&(s.MessageBox.prototype.getView=function(){return e.messageBoxView})}},s.addContext("default",{blockoutOpacity:.2,removeDelay:200,addHost:function(e){var t=o("body"),i=o('<div class="modalBlockout"></div>').css({"z-index":s.getNextZIndex(),opacity:this.blockoutOpacity}).appendTo(t),n=o('<div class="modalHost"></div>').css({"z-index":s.getNextZIndex()}).appendTo(t);if(e.host=n.get(0),e.blockout=i.get(0),!s.isOpen()){e.oldBodyMarginRight=t.css("margin-right"),e.oldInlineMarginRight=t.get(0).style.marginRight;var r=o("html"),a=t.outerWidth(!0),u=r.scrollTop();o("html").css("overflow-y","hidden");var c=o("body").outerWidth(!0);t.css("margin-right",c-a+parseInt(e.oldBodyMarginRight)+"px"),r.scrollTop(u)}},removeHost:function(e){if(o(e.host).css("opacity",0),o(e.blockout).css("opacity",0),setTimeout(function(){a.removeNode(e.host),a.removeNode(e.blockout)},this.removeDelay),!s.isOpen()){var t=o("html"),i=t.scrollTop();t.css("overflow-y","").scrollTop(i),e.oldInlineMarginRight?o("body").css("margin-right",e.oldBodyMarginRight):o("body").css("margin-right","")}},compositionComplete:function(e,t,i){var n=o(e),r=n.width(),a=n.height(),u=s.getDialog(i.model);n.css({"margin-top":(-a/2).toString()+"px","margin-left":(-r/2).toString()+"px"}),o(u.host).css("opacity",1),o(e).hasClass("autoclose")&&o(u.blockout).click(function(){u.close()}),o(".autofocus",e).each(function(){o(this).focus()})}}),s});