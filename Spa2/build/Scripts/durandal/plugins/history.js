define(["durandal/system","jquery"],function(e,t){function n(e,t,n){if(n){var i=e.href.replace(/(javascript:|#).*$/,"");e.replace(i+"#"+t)}else e.hash="#"+t}var i=/^[#\/]|\s+$/g,r=/^\/+|\/+$/g,o=/msie [\w.]+/,a=/\/$/,u={interval:50,active:!1};return"undefined"!=typeof window&&(u.location=window.location,u.history=window.history),u.getHash=function(e){var t=(e||u).location.href.match(/#(.*)$/);return t?t[1]:""},u.getFragment=function(e,t){if(null==e)if(u._hasPushState||!u._wantsHashChange||t){e=u.location.pathname;var n=u.root.replace(a,"");e.indexOf(n)||(e=e.substr(n.length))}else e=u.getHash();return e.replace(i,"")},u.activate=function(n){u.active&&e.error("History has already been activated."),u.active=!0,u.options=e.extend({},{root:"/"},u.options,n),u.root=u.options.root,u._wantsHashChange=u.options.hashChange!==!1,u._wantsPushState=!!u.options.pushState,u._hasPushState=!!(u.options.pushState&&u.history&&u.history.pushState);var a=u.getFragment(),s=document.documentMode,c=o.exec(navigator.userAgent.toLowerCase())&&(!s||7>=s);u.root=("/"+u.root+"/").replace(r,"/"),c&&u._wantsHashChange&&(u.iframe=t('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,u.navigate(a,!1)),u._hasPushState?t(window).on("popstate",u.checkUrl):u._wantsHashChange&&"onhashchange"in window&&!c?t(window).on("hashchange",u.checkUrl):u._wantsHashChange&&(u._checkUrlInterval=setInterval(u.checkUrl,u.interval)),u.fragment=a;var l=u.location,d=l.pathname.replace(/[^\/]$/,"$&/")===u.root;if(u._wantsHashChange&&u._wantsPushState){if(!u._hasPushState&&!d)return u.fragment=u.getFragment(null,!0),u.location.replace(u.root+u.location.search+"#"+u.fragment),!0;u._hasPushState&&d&&l.hash&&(this.fragment=u.getHash().replace(i,""),this.history.replaceState({},document.title,u.root+u.fragment+l.search))}return u.options.silent?void 0:u.loadUrl()},u.deactivate=function(){t(window).off("popstate",u.checkUrl).off("hashchange",u.checkUrl),clearInterval(u._checkUrlInterval),u.active=!1},u.checkUrl=function(){var e=u.getFragment();return e===u.fragment&&u.iframe&&(e=u.getFragment(u.getHash(u.iframe))),e===u.fragment?!1:(u.iframe&&u.navigate(e,!1),u.loadUrl(),void 0)},u.loadUrl=function(e){var t=u.fragment=u.getFragment(e);return u.options.routeHandler?u.options.routeHandler(t):!1},u.navigate=function(t,i){if(!u.active)return!1;if(void 0===i?i={trigger:!0}:e.isBoolean(i)&&(i={trigger:i}),t=u.getFragment(t||""),u.fragment!==t){u.fragment=t;var r=u.root+t;if(u._hasPushState)u.history[i.replace?"replaceState":"pushState"]({},document.title,r);else{if(!u._wantsHashChange)return u.location.assign(r);n(u.location,t,i.replace),u.iframe&&t!==u.getFragment(u.getHash(u.iframe))&&(i.replace||u.iframe.document.open().close(),n(u.iframe.location,t,i.replace))}return i.trigger?u.loadUrl(t):void 0}},u.navigateBack=function(){u.history.back()},u});